{"version":3,"file":"chord-diagram.js","sources":["../../../home/runner/work/metastanza/metastanza/stanzas/chord-diagram/index.js"],"sourcesContent":["import Stanza from \"togostanza/stanza\";\nimport * as d3 from \"d3\";\n\nexport default class ChordDiagram extends Stanza {\n  async render() {\n\n    // geometry\n    // window.getComputedStyle(this.element).getPropertyValue('--width')\n    const [width, height] = [this.params[\"width\"], this.params[\"height\"]];\n    const innerRadius = Math.min(width, height) * 0.5 - 20;\n    const outerRadius = innerRadius + 6;\n    const formatValue = (x) => `${x.toFixed(0)}B`;\n\n    const _svg = document.createElementNS(\"http://www.w3.org/2000/svg\", \"svg\");\n    this.root.querySelector(\"main\").append(_svg);\n    const svg = d3.select(_svg);\n    svg.attr(\"width\", width).attr(\"height\", height);\n\n    // data\n    const data = await (() => {\n      // console.log(this.params[\"data-url\"])\n      switch (this.params[\"data-type\"]) {\n        case \"json\":\n          // return d3.json('./chord-diagram/assets/directed-graph-data.json', (data) => data);\n          return d3.json(this.params[\"data-url\"], (data) => data);\n        case \"tsv\":\n          return d3.tsv(this.params[\"data-url\"], (data) => data);\n      }\n      // switch (this.params[\"data-type\"]) {\n      //   case \"json\":\n      //     return d3.json(this.params[\"data-url\"], (data) => data);\n      //   case \"tsv\":\n      //     return d3.tsv(this.params[\"data-url\"], (data) => data);\n      // }\n    })();\n    const names = Array.from(\n      new Set(data.flatMap((d) => [d.source, d.target]))\n    );\n    // console.log(names)\n    const matrix = (() => {\n      const index = new Map(names.map((name, i) => [name, i]));\n      const matrix = Array.from(index, () => new Array(names.length).fill(0));\n      for (const { source, target, value } of data) {\n        matrix[index.get(source)][index.get(target)] += value;\n      }\n      return matrix;\n    })();\n    // console.log(matrix)\n\n    // prepare some D3 objects\n    const color = {\n      count: names.length,\n      hue(index) {\n        return (1 / this.count) * index;\n      },\n      hsl(index) {\n        return `hsl(${this.hue(index)}turn, 70%, 60%)`;\n      },\n    };\n\n    // const color = d3.scaleOrdinal(names, d3.schemeCategory10)\n    const ribbon = d3\n      .ribbonArrow()\n      .radius(innerRadius - this.params[\"edge-offset\"])\n      .padAngle(1 / innerRadius);\n    const arc = d3.arc().innerRadius(innerRadius).outerRadius(outerRadius);\n    const chord = d3\n      .chordDirected()\n      .padAngle(this.params[\"arcs-gap\"] / innerRadius)\n      .sortSubgroups(d3.descending)\n      .sortChords(d3.descending);\n    const chords = chord(matrix);\n\n    const fullsircleId = `fullsircle${new Date().getTime()}`;\n\n    const rootGroup = svg\n      .append(\"g\")\n      .attr(\"transform\", `translate(${[width * 0.5, height * 0.5]})`);\n\n    rootGroup\n      .append(\"path\")\n      .classed(\"fullsircle\", true)\n      .attr(\"id\", fullsircleId)\n      .attr(\n        \"d\",\n        d3.arc()({ outerRadius, startAngle: 0, endAngle: 2 * Math.PI })\n      );\n\n    rootGroup\n      .append(\"g\")\n      .classed(\"ribbons\", true)\n      .selectAll(\"g\")\n      .data(chords)\n      .join(\"path\")\n      .attr(\"d\", ribbon)\n      // .attr('fill', d => color(names[d.target.index]))\n      .attr(\"fill\", (d) => color.hsl(d.target.index))\n      .append(\"title\")\n      .text(\n        (d) =>\n          `${names[d.source.index]} owes ${names[d.target.index]} ${formatValue(\n            d.source.value\n          )}`\n      );\n\n    rootGroup\n      .append(\"g\")\n      .classed(\"arcs\", true)\n      .selectAll(\"g\")\n      .data(chords.groups)\n      .join(\"g\")\n      .call((g) =>\n        g\n          .append(\"path\")\n          .attr(\"d\", arc)\n          // .attr('fill', d => color(names[d.index]))\n          .attr(\"fill\", (d) => color.hsl(d.index))\n          .attr(\"stroke\", \"#fff\")\n      )\n      .call((g) =>\n        g\n          .append(\"text\")\n          .attr(\"dy\", -3)\n          .append(\"textPath\")\n          // .attr('xlink:href', textId.href)\n          .attr(\"xlink:href\", () => `#${fullsircleId}`)\n          .attr(\"startOffset\", (d) => d.startAngle * outerRadius)\n          .text((d) => names[d.index])\n      )\n      .call((g) =>\n        g.append(\"title\").text(\n          (d) => `${names[d.index]}\n          owes ${formatValue(d3.sum(matrix[d.index]))}\n          is owed ${formatValue(d3.sum(matrix, (row) => row[d.index]))}`\n        )\n      );\n  }\n}\n"],"names":["d3.select","d3.json","d3.tsv","d3\n      .ribbonArrow","d3.arc","d3\n      .chordDirected","d3.descending","d3.sum"],"mappings":"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"}