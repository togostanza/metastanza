{"version":3,"file":"quantile-dot-plot.js","sources":["../../../home/runner/work/metastanza/metastanza/stanzas/quantile-dot-plot/index.js"],"sourcesContent":["import Stanza from \"togostanza/stanza\";\nimport vegaEmbed from \"vega-embed\";\n\nexport default class quantileDotPlot extends Stanza {\n  async render() {\n    //width,height,padding\n    const width = Number(this.params[\"width\"]);\n    const height = Number(this.params[\"height\"]);\n    const padding = Number(this.params[\"padding\"]);\n\n    const vegaJson = await fetch(\n      \"https://vega.github.io/vega/examples/quantile-dot-plot.vg.json\"\n    ).then((res) => res.json());\n\n    const signals = [\n      {\n        name: \"quantiles\",\n        value: 20,\n        bind: { input: \"range\", min: 10, max: 200, step: 1 },\n      },\n      { name: \"mean\", update: \"log(11.4)\" },\n      { name: \"sd\", value: 0.2 },\n      { name: \"step\", update: \"1.25 * sqrt(20 / quantiles)\" },\n      { name: \"size\", update: \"scale('x', step) - scale('x', 0)\" },\n      { name: \"area\", update: \"size * size\" },\n      {\n        name: \"select\",\n        init: \"quantileLogNormal(0.05, mean, sd)\",\n        on: [\n          {\n            events: \"click, [mousedown, window:mouseup] > mousemove\",\n            update: \"clamp(invert('x', x()), 0.0001, 30)\",\n          },\n          {\n            events: \"dblclick\",\n            update: \"0\",\n          },\n        ],\n      },\n    ];\n\n    const data = [\n      {\n        name: \"quantiles\",\n        transform: [\n          {\n            type: \"sequence\",\n            as: \"p\",\n            start: { signal: \"0.5 / quantiles\" },\n            step: { signal: \"1 / quantiles\" },\n            stop: 1,\n          },\n          {\n            type: \"formula\",\n            as: \"value\",\n            expr: \"quantileLogNormal(datum.p, mean, sd)\",\n          },\n          {\n            type: \"dotbin\",\n            field: \"value\",\n            step: { signal: \"step\" },\n          },\n          {\n            type: \"stack\",\n            groupby: [\"bin\"],\n          },\n          {\n            type: \"extent\",\n            field: \"y1\",\n            signal: \"ext\",\n          },\n        ],\n      },\n    ];\n\n    // objects for marks\n    const getSignalByColor = (color, color2 = \"transparant\") => {\n      return `select ? '${color}': '${color2}'`;\n    };\n\n    const scales = [\n      {\n        name: \"x\",\n        domain: [this.params[\"x-domain-start\"], this.params[\"x-domain-end\"]],\n        range: \"width\",\n      },\n      {\n        name: \"y\",\n        domain: { signal: \"[0, height / size]\" },\n        range: \"height\",\n      },\n    ];\n\n    const symbol = {\n      type: \"symbol\",\n      from: { data: \"quantiles\" },\n      encode: {\n        enter: {\n          x: { scale: \"x\", field: \"bin\" },\n          y: { scale: \"y\", signal: \"datum.y0 + 0.5\" },\n          size: { signal: \"area\" },\n        },\n        update: {\n          fill: {\n            signal:\n              \"datum.bin <\" +\n              getSignalByColor(\n                \"var(--togostanza-fill-selected)\",\n                \"var(--togostanza-fill-unselected)\"\n              ),\n          },\n        },\n      },\n    };\n\n    const rule = {\n      type: \"rule\",\n      interactive: false,\n      encode: {\n        update: {\n          x: { scale: \"x\", signal: \"select\" },\n          y: { value: 0 },\n          y2: { signal: \"height\" },\n          stroke: {\n            signal: getSignalByColor(\"var(--togostanza-stroke-signal)\"),\n          },\n        },\n      },\n    };\n\n    const text = {\n      type: \"text\",\n      interactive: false,\n      encode: {\n        enter: {\n          baseline: { value: \"top\" },\n          dx: { value: 3 },\n          y: { value: 3 },\n        },\n        update: {\n          x: { scale: \"x\", signal: \"select\" },\n          text: {\n            signal: \"format(cumulativeLogNormal(select, mean, sd), '.1%')\",\n          },\n          fill: { signal: getSignalByColor(\"#002559\") },\n        },\n      },\n    };\n\n    const spec = {\n      $schema: \"https://vega.github.io/schema/vega/v5.json\",\n      width,\n      height,\n      padding,\n      signals,\n      axes: vegaJson.axes,\n      data,\n      scales,\n      marks: [symbol, rule, text],\n    };\n\n    const el = this.root.querySelector(\"main\");\n    const opts = {\n      renderer: \"svg\",\n    };\n    console.log(this.params[\"x-domain-start\"]);\n    await vegaEmbed(el, spec, opts);\n  }\n}\n"],"names":["vegaEmbed"],"mappings":"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"}