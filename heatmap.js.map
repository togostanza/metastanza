{"version":3,"file":"heatmap.js","sources":["../../../home/runner/work/metastanza/metastanza/stanzas/heatmap/index.js"],"sourcesContent":["import Stanza from \"togostanza/stanza\";\nimport loadData from \"togostanza-utils/load-data\";\nimport ToolTip from \"@/lib/ToolTip\";\nimport Legend from \"@/lib/Legend\";\n\nimport * as d3 from \"d3\";\n\nconst tooltipHTML = ({ group, variable, value }) =>\n  `<span><strong>${group},${variable}: </strong>${value}</span>`;\n\nexport default class Heatmap extends Stanza {\n  css(key) {\n    return getComputedStyle(this.element).getPropertyValue(key);\n  }\n  async render() {\n    const root = this.root.querySelector(\"main\");\n    if (!this.tooltip) {\n      this.tooltip = new ToolTip();\n      root.append(this.tooltip);\n      this.legend = new Legend();\n      root.append(this.legend);\n    }\n\n    const data = await loadData(\n      this.params[\"data-url\"],\n      this.params[\"data-type\"]\n    );\n\n    this.draw(root, data);\n  }\n  async draw(el, dataset) {\n    const tickSize = +this.css(\"--togostanza-tick-size\") || 0;\n    const xLabelAngle = this.params[\"x-label-angle\"] || 0;\n    const yLabelAngle = this.params[\"y-label-angle\"] || 0;\n\n    // set the dimensions and margins of the graph\n    const margin = {\n      bottom: +this.css(\"--togostanza-font-size\") + tickSize + 10,\n      left: +this.css(\"--togostanza-font-size\") + tickSize + 10,\n    };\n    const width = this.params[\"width\"] - margin.left,\n      height = this.params[\"height\"] - margin.bottom;\n\n    // remove svg element whenthis.params updated\n    d3.select(el).select(\"svg\").remove();\n\n    const svg = d3\n      .select(el)\n      .append(\"svg\")\n      .attr(\"width\", width + margin.left)\n      .attr(\"height\", height + margin.bottom);\n\n    const graphArea = svg\n      .append(\"g\")\n      .attr(\"class\", \"chart\")\n      .attr(\"transform\", `translate(${margin.left}, 0 )`);\n\n    const rows = [...new Set(dataset.map((d) => d.group))];\n    const columns = [...new Set(dataset.map((d) => d.variable))];\n\n    const x = d3.scaleBand().domain(rows).range([0, width]).padding(0.01);\n\n    const xAxisGenerator = d3\n      .axisBottom(x)\n      .tickSizeOuter(0)\n      .tickSizeInner(tickSize);\n\n    const y = d3.scaleBand().range([height, 0]).domain(columns).padding(0.01);\n    const yAxisGridGenerator = d3\n      .axisLeft(y)\n      .tickSizeOuter(0)\n      .tickSizeInner(tickSize);\n\n    graphArea\n      .append(\"g\")\n      .attr(\"class\", \"x-axis\")\n      .attr(\"transform\", `translate(0, ${height})`)\n      .transition()\n      .duration(200)\n      .call(xAxisGenerator)\n      .selectAll(\"text\")\n      .attr(\"transform\", `rotate(${xLabelAngle})`);\n\n    graphArea\n      .append(\"g\")\n      .classed(\"class\", \"y-axis\")\n      .transition()\n      .duration(200)\n      .call(yAxisGridGenerator)\n      .selectAll(\"text\")\n      .attr(\"transform\", `rotate(${yLabelAngle})`);\n\n    if (!this.params[\"show-domains\"]) {\n      svg.selectAll(\".domain\").remove();\n    }\n    if (!this.params[\"show-tick-lines\"]) {\n      svg.selectAll(\".tick line\").remove();\n    }\n\n    graphArea.selectAll(\"text\").attr(\"class\", \"text\");\n\n    const myColor = d3\n      .scaleLinear()\n      .range([\n        this.css(\"--togostanza-series-0-color\"),\n        this.css(\"--togostanza-series-1-color\"),\n      ])\n      .domain([1, 100]);\n\n    graphArea\n      .selectAll()\n      .data(dataset, function (d) {\n        return d.group + \":\" + d.variable;\n      })\n      .enter()\n      .append(\"rect\")\n      .attr(\"x\", (d) => x(d.group))\n      .attr(\"y\", (d) => y(d.variable))\n      .attr(\"data-tooltip-html\", true)\n      .attr(\"data-tooltip\", (d) => tooltipHTML(d))\n      .attr(\"width\", x.bandwidth())\n      .attr(\"height\", y.bandwidth())\n      .attr(\"rx\", this.css(\"--togostanza-border-radius\"))\n      .attr(\"ry\", this.css(\"--togostanza-border-radius\"))\n      .style(\"fill\", (d) => myColor(d.value))\n      .on(\"mouseover\", mouseover)\n      .on(\"mouseleave\", mouseleave);\n\n    const values = [...new Set(dataset.map((d) => d.value))];\n\n    this.tooltip.setup(el.querySelectorAll(\"[data-tooltip]\"));\n    this.legend.setup(\n      this.intervals(values, myColor),\n      {},\n      this.root.querySelector(\"main\")\n    );\n\n    function mouseover() {\n      d3.select(this).classed(\"highlighted\", true);\n    }\n    function mouseleave() {\n      d3.select(this).classed(\"highlighted\", false);\n    }\n  }\n  // create legend objects based on min and max data values with number of steps as set by user in this.params\n  intervals(\n    values,\n    color,\n    steps = this.params[\"legend-groups\"] >= 2 ? this.params[\"legend-groups\"] : 2\n  ) {\n    const [min, max] = [Math.min(...values), Math.max(...values)];\n    return [...Array(steps).keys()].map((i) => {\n      const n = Math.round(min + i * ((max - min) / steps));\n      return {\n        label: n,\n        color: color(n),\n      };\n    });\n  }\n}\n"],"names":["d3.select","d3\n      .select","d3.scaleBand","d3\n      .axisBottom","d3\n      .axisLeft","d3\n      .scaleLinear"],"mappings":"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"}