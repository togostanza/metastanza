{"version":3,"file":"region-geographic-map.js","sources":["../../../home/runner/work/metastanza/metastanza/stanzas/region-geographic-map/index.js"],"sourcesContent":["import Stanza from \"togostanza/stanza\";\nimport vegaEmbed from \"vega-embed\";\nimport loadData from \"togostanza-utils/load-data\";\nimport {\n  downloadSvgMenuItem,\n  downloadPngMenuItem,\n  downloadJSONMenuItem,\n  downloadCSVMenuItem,\n  downloadTSVMenuItem,\n  copyHTMLSnippetToClipboardMenuItem,\n} from \"togostanza-utils\";\n\nconst areas = new Map([\n  [\n    \"us\",\n    {\n      name: \"map\",\n      url: \"https://vega.github.io/vega/data/us-10m.json\",\n      format: { type: \"topojson\", feature: \"counties\" },\n    },\n  ],\n  [\n    \"world\",\n    {\n      name: \"map\",\n      url: \"https://vega.github.io/vega/data/world-110m.json\",\n      format: {\n        type: \"topojson\",\n        feature: \"countries\",\n      },\n    },\n  ],\n]);\nexport default class regionGeographicMap extends Stanza {\n  menu() {\n    return [\n      downloadSvgMenuItem(this, \"region-geographis-map\"),\n      downloadPngMenuItem(this, \"region-geographis-map\"),\n      downloadJSONMenuItem(this, \"region-geographis-map\", this._data),\n      downloadCSVMenuItem(this, \"region-geographis-map\", this._data),\n      downloadTSVMenuItem(this, \"region-geographis-map\", this._data),\n      copyHTMLSnippetToClipboardMenuItem(this),\n    ];\n  }\n\n  async render() {\n    const values = await loadData(\n      this.params[\"data-url\"],\n      this.params[\"data-type\"],\n      this.root.querySelector(\"main\")\n    );\n\n    this._data = values;\n\n    const valObj = {\n      name: \"userData\",\n      values,\n    };\n\n    const transform = [\n      {\n        type: \"lookup\",\n        from: \"userData\",\n        key: \"id\",\n        fields: [\"id\"],\n        values: [this.params[\"value-key\"]],\n      },\n    ];\n\n    const obj = areas.get(this.params[\"area\"]);\n    obj.transform = transform;\n    const data = [valObj, obj];\n\n    const projections = [\n      {\n        name: \"projection\",\n        type: this.params[\"area\"] === \"us\" ? \"albersUsa\" : \"mercator\",\n      },\n    ];\n\n    const colorRangeMax = [\n      \"var(--togostanza-series-0-color)\",\n      \"var(--togostanza-series-1-color)\",\n      \"var(--togostanza-series-2-color)\",\n      \"var(--togostanza-series-3-color)\",\n      \"var(--togostanza-series-4-color)\",\n      \"var(--togostanza-series-5-color)\",\n      \"var(--togostanza-series-6-color)\",\n      \"var(--togostanza-series-7-color)\",\n    ];\n\n    const colorRange = colorRangeMax.slice(\n      0,\n      Number(this.params[\"group-amount\"])\n    );\n\n    const scales = [\n      {\n        name: \"userColor\",\n        type: \"quantize\",\n        domain: [0, 0.15],\n        range: colorRange,\n      },\n    ];\n\n    const legends = [\n      {\n        fill: \"userColor\",\n        orient: this.params[\"legend-orient\"],\n        title: this.params[\"legend-title\"],\n        titleColor: \"var(--togostanza-title-font-color)\",\n        titleFont: \"var(--togostanza-font-family)\",\n        titleFontWeight: \"var(--togostanza-title-font-weight)\",\n        format: this.params[\"percentage\"] ? \"0.1%\" : \"\",\n      },\n    ];\n\n    const marks = [\n      {\n        type: \"shape\",\n        from: { data: \"map\" },\n        encode: {\n          enter: {\n            tooltip: {\n              signal: this.params[\"percentage\"]\n                ? `format(datum.${this.params[\"value-key\"]}, '0.1%')`\n                : `datum.${this.params[\"value-key\"]}`,\n            },\n          },\n          hover: {\n            fill: { value: \"var(--togostanza-hover-color)\" },\n          },\n          update: {\n            fill: { scale: \"userColor\", field: this.params[\"value-key\"] },\n            stroke: this.params[\"border\"]\n              ? { value: \"var(--togostanza-region-border-color)\" }\n              : \"\",\n          },\n        },\n        transform: [{ type: \"geoshape\", projection: \"projection\" }],\n      },\n    ];\n\n    const spec = {\n      $schema: \"https://vega.github.io/schema/vega/v5.json\",\n      width: 1000,\n      height: 500,\n      data,\n      projections,\n      scales,\n      legends: this.params[\"legend\"] ? legends : [],\n      marks,\n    };\n\n    const el = this.root.querySelector(\"main\");\n    const opts = {\n      renderer: \"svg\",\n    };\n    await vegaEmbed(el, spec, opts);\n  }\n}\n"],"names":["vegaEmbed"],"mappings":"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"}